<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Proper maintenance and care of multi-threading locks · The Julia Language</title><meta name="title" content="Proper maintenance and care of multi-threading locks · The Julia Language"/><meta property="og:title" content="Proper maintenance and care of multi-threading locks · The Julia Language"/><meta property="twitter:title" content="Proper maintenance and care of multi-threading locks · The Julia Language"/><meta name="description" content="Documentation for The Julia Language."/><meta property="og:description" content="Documentation for The Julia Language."/><meta property="twitter:description" content="Documentation for The Julia Language."/><meta property="og:url" content="https://docs.julialang.org/en/v1/devdocs/locks/"/><meta property="twitter:url" content="https://docs.julialang.org/en/v1/devdocs/locks/"/><link rel="canonical" href="https://docs.julialang.org/en/v1/devdocs/locks/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-28835595-6"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-28835595-6', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/julia-manual.css" rel="stylesheet" type="text/css"/><link href="../../assets/julia.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.svg" alt="The Julia Language logo"/><img class="docs-dark-only" src="../../assets/logo-dark.svg" alt="The Julia Language logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Julia Documentation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../manual/getting-started/">Getting Started</a></li><li><a class="tocitem" href="../../manual/installation/">Installation</a></li><li><a class="tocitem" href="../../manual/variables/">Variables</a></li><li><a class="tocitem" href="../../manual/integers-and-floating-point-numbers/">Integers and Floating-Point Numbers</a></li><li><a class="tocitem" href="../../manual/mathematical-operations/">Mathematical Operations and Elementary Functions</a></li><li><a class="tocitem" href="../../manual/complex-and-rational-numbers/">Complex and Rational Numbers</a></li><li><a class="tocitem" href="../../manual/strings/">Strings</a></li><li><a class="tocitem" href="../../manual/functions/">Functions</a></li><li><a class="tocitem" href="../../manual/control-flow/">Control Flow</a></li><li><a class="tocitem" href="../../manual/variables-and-scoping/">Scope of Variables</a></li><li><a class="tocitem" href="../../manual/types/">Types</a></li><li><a class="tocitem" href="../../manual/methods/">Methods</a></li><li><a class="tocitem" href="../../manual/constructors/">Constructors</a></li><li><a class="tocitem" href="../../manual/conversion-and-promotion/">Conversion and Promotion</a></li><li><a class="tocitem" href="../../manual/interfaces/">Interfaces</a></li><li><a class="tocitem" href="../../manual/modules/">Modules</a></li><li><a class="tocitem" href="../../manual/documentation/">Documentation</a></li><li><a class="tocitem" href="../../manual/metaprogramming/">Metaprogramming</a></li><li><a class="tocitem" href="../../manual/arrays/">Single- and multi-dimensional Arrays</a></li><li><a class="tocitem" href="../../manual/missing/">Missing Values</a></li><li><a class="tocitem" href="../../manual/networking-and-streams/">Networking and Streams</a></li><li><a class="tocitem" href="../../manual/parallel-computing/">Parallel Computing</a></li><li><a class="tocitem" href="../../manual/asynchronous-programming/">Asynchronous Programming</a></li><li><a class="tocitem" href="../../manual/multi-threading/">Multi-Threading</a></li><li><a class="tocitem" href="../../manual/distributed-computing/">Multi-processing and Distributed Computing</a></li><li><a class="tocitem" href="../../manual/running-external-programs/">Running External Programs</a></li><li><a class="tocitem" href="../../manual/calling-c-and-fortran-code/">Calling C and Fortran Code</a></li><li><a class="tocitem" href="../../manual/handling-operating-system-variation/">Handling Operating System Variation</a></li><li><a class="tocitem" href="../../manual/environment-variables/">Environment Variables</a></li><li><a class="tocitem" href="../../manual/embedding/">Embedding Julia</a></li><li><a class="tocitem" href="../../manual/code-loading/">Code Loading</a></li><li><a class="tocitem" href="../../manual/profile/">Profiling</a></li><li><a class="tocitem" href="../../manual/stacktraces/">Stack Traces</a></li><li><a class="tocitem" href="../../manual/memory-management/">Memory Management and Garbage Collection</a></li><li><a class="tocitem" href="../../manual/performance-tips/">Performance Tips</a></li><li><a class="tocitem" href="../../manual/workflow-tips/">Workflow Tips</a></li><li><a class="tocitem" href="../../manual/style-guide/">Style Guide</a></li><li><a class="tocitem" href="../../manual/faq/">Frequently Asked Questions</a></li><li><a class="tocitem" href="../../manual/noteworthy-differences/">Noteworthy Differences from other Languages</a></li><li><a class="tocitem" href="../../manual/unicode-input/">Unicode Input</a></li><li><a class="tocitem" href="../../manual/command-line-interface/">Command-line Interface</a></li><li><a class="tocitem" href="../../manual/worldage/">The World Age mechanism</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Base</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../base/base/">Essentials</a></li><li><a class="tocitem" href="../../base/collections/">Collections and Data Structures</a></li><li><a class="tocitem" href="../../base/math/">Mathematics</a></li><li><a class="tocitem" href="../../base/numbers/">Numbers</a></li><li><a class="tocitem" href="../../base/strings/">Strings</a></li><li><a class="tocitem" href="../../base/arrays/">Arrays</a></li><li><a class="tocitem" href="../../base/parallel/">Tasks</a></li><li><a class="tocitem" href="../../base/multi-threading/">Multi-Threading</a></li><li><a class="tocitem" href="../../base/scopedvalues/">Scoped Values</a></li><li><a class="tocitem" href="../../base/constants/">Constants</a></li><li><a class="tocitem" href="../../base/file/">Filesystem</a></li><li><a class="tocitem" href="../../base/io-network/">I/O and Network</a></li><li><a class="tocitem" href="../../base/punctuation/">Punctuation</a></li><li><a class="tocitem" href="../../base/sort/">Sorting and Related Functions</a></li><li><a class="tocitem" href="../../base/iterators/">Iteration utilities</a></li><li><a class="tocitem" href="../../base/reflection/">Reflection and introspection</a></li><li><a class="tocitem" href="../../base/c/">C Interface</a></li><li><a class="tocitem" href="../../base/libc/">C Standard Library</a></li><li><a class="tocitem" href="../../base/stacktraces/">StackTraces</a></li><li><a class="tocitem" href="../../base/simd-types/">SIMD Support</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Standard Library</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../stdlib/ArgTools/">ArgTools</a></li><li><a class="tocitem" href="../../stdlib/Artifacts/">Artifacts</a></li><li><a class="tocitem" href="../../stdlib/Base64/">Base64</a></li><li><a class="tocitem" href="../../stdlib/CRC32c/">CRC32c</a></li><li><a class="tocitem" href="../../stdlib/Dates/">Dates</a></li><li><a class="tocitem" href="../../stdlib/DelimitedFiles/">Delimited Files</a></li><li><a class="tocitem" href="../../stdlib/Distributed/">Distributed Computing</a></li><li><a class="tocitem" href="../../stdlib/Downloads/">Downloads</a></li><li><a class="tocitem" href="../../stdlib/FileWatching/">File Events</a></li><li><a class="tocitem" href="../../stdlib/Future/">Future</a></li><li><a class="tocitem" href="../../stdlib/InteractiveUtils/">Interactive Utilities</a></li><li><a class="tocitem" href="../../stdlib/JuliaSyntaxHighlighting/">Julia Syntax Highlighting</a></li><li><a class="tocitem" href="../../stdlib/LazyArtifacts/">Lazy Artifacts</a></li><li><a class="tocitem" href="../../stdlib/LibCURL/">LibCURL</a></li><li><a class="tocitem" href="../../stdlib/LibGit2/">LibGit2</a></li><li><a class="tocitem" href="../../stdlib/Libdl/">Dynamic Linker</a></li><li><a class="tocitem" href="../../stdlib/LinearAlgebra/">Linear Algebra</a></li><li><a class="tocitem" href="../../stdlib/Logging/">Logging</a></li><li><a class="tocitem" href="../../stdlib/Markdown/">Markdown</a></li><li><a class="tocitem" href="../../stdlib/Mmap/">Memory-mapped I/O</a></li><li><a class="tocitem" href="../../stdlib/NetworkOptions/">Network Options</a></li><li><a class="tocitem" href="../../stdlib/Pkg/">Pkg</a></li><li><a class="tocitem" href="../../stdlib/Printf/">Printf</a></li><li><a class="tocitem" href="../../stdlib/Profile/">Profiling</a></li><li><a class="tocitem" href="../../stdlib/REPL/">The Julia REPL</a></li><li><a class="tocitem" href="../../stdlib/Random/">Random Numbers</a></li><li><a class="tocitem" href="../../stdlib/SHA/">SHA</a></li><li><a class="tocitem" href="../../stdlib/Serialization/">Serialization</a></li><li><a class="tocitem" href="../../stdlib/SharedArrays/">Shared Arrays</a></li><li><a class="tocitem" href="../../stdlib/Sockets/">Sockets</a></li><li><a class="tocitem" href="../../stdlib/SparseArrays/">Sparse Arrays</a></li><li><a class="tocitem" href="../../stdlib/Statistics/">Statistics</a></li><li><a class="tocitem" href="../../stdlib/StyledStrings/">StyledStrings</a></li><li><a class="tocitem" href="../../stdlib/TOML/">TOML</a></li><li><a class="tocitem" href="../../stdlib/Tar/">Tar</a></li><li><a class="tocitem" href="../../stdlib/Test/">Unit Testing</a></li><li><a class="tocitem" href="../../stdlib/UUIDs/">UUIDs</a></li><li><a class="tocitem" href="../../stdlib/Unicode/">Unicode</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Developer Documentation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-6-1" type="checkbox" checked/><label class="tocitem" for="menuitem-6-1"><span class="docs-label">Documentation of Julia&#39;s Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../init/">Initialization of the Julia runtime</a></li><li><a class="tocitem" href="../ast/">Julia ASTs</a></li><li><a class="tocitem" href="../types/">More about types</a></li><li><a class="tocitem" href="../object/">Memory layout of Julia Objects</a></li><li><a class="tocitem" href="../eval/">Eval of Julia code</a></li><li><a class="tocitem" href="../callconv/">Calling Conventions</a></li><li><a class="tocitem" href="../compiler/">High-level Overview of the Native-Code Generation Process</a></li><li><a class="tocitem" href="../functions/">Julia Functions</a></li><li><a class="tocitem" href="../cartesian/">Base.Cartesian</a></li><li><a class="tocitem" href="../meta/">Talking to the compiler (the <code>:meta</code> mechanism)</a></li><li><a class="tocitem" href="../subarrays/">SubArrays</a></li><li><a class="tocitem" href="../isbitsunionarrays/">isbits Union Optimizations</a></li><li><a class="tocitem" href="../sysimg/">System Image Building</a></li><li><a class="tocitem" href="../pkgimg/">Package Images</a></li><li><a class="tocitem" href="../llvm-passes/">Custom LLVM Passes</a></li><li><a class="tocitem" href="../llvm/">Working with LLVM</a></li><li><a class="tocitem" href="../stdio/">printf() and stdio in the Julia runtime</a></li><li><a class="tocitem" href="../boundscheck/">Bounds checking</a></li><li class="is-active"><a class="tocitem" href>Proper maintenance and care of multi-threading locks</a><ul class="internal"><li><a class="tocitem" href="#Types-of-locks"><span>Types of locks</span></a></li><li><a class="tocitem" href="#Lock-hierarchy"><span>Lock hierarchy</span></a></li><li><a class="tocitem" href="#Exceptions-to-the-lock-hierarchy"><span>Exceptions to the lock hierarchy</span></a></li><li><a class="tocitem" href="#Updates-to-the-world-counter"><span>Updates to the world counter</span></a></li><li><a class="tocitem" href="#man-lock-free-data"><span>Lock free data structures</span></a></li></ul></li><li><a class="tocitem" href="../offset-arrays/">Arrays with custom indices</a></li><li><a class="tocitem" href="../require/">Module loading</a></li><li><a class="tocitem" href="../inference/">Inference</a></li><li><a class="tocitem" href="../ssair/">Julia SSA-form IR</a></li><li><a class="tocitem" href="../EscapeAnalysis/"><code>EscapeAnalysis</code></a></li><li><a class="tocitem" href="../aot/">Ahead of Time Compilation</a></li><li><a class="tocitem" href="../gc-sa/">Static analyzer annotations for GC correctness in C code</a></li><li><a class="tocitem" href="../gc/">Garbage Collection in Julia</a></li><li><a class="tocitem" href="../gc-mmtk/">Julia + MMTk</a></li><li><a class="tocitem" href="../jit/">JIT Design and Implementation</a></li><li><a class="tocitem" href="../builtins/">Core.Builtins</a></li><li><a class="tocitem" href="../precompile_hang/">Fixing precompilation hangs due to open tasks or IO</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-2" type="checkbox"/><label class="tocitem" for="menuitem-6-2"><span class="docs-label">Developing/debugging Julia&#39;s C code</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../backtraces/">Reporting and analyzing crashes (segfaults)</a></li><li><a class="tocitem" href="../debuggingtips/">gdb debugging tips</a></li><li><a class="tocitem" href="../valgrind/">Using Valgrind with Julia</a></li><li><a class="tocitem" href="../external_profilers/">External Profiler Support</a></li><li><a class="tocitem" href="../sanitizers/">Sanitizer support</a></li><li><a class="tocitem" href="../probes/">Instrumenting Julia with DTrace, and bpftrace</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-3" type="checkbox"/><label class="tocitem" for="menuitem-6-3"><span class="docs-label">Building Julia</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../build/build/">Building Julia (Detailed)</a></li><li><a class="tocitem" href="../build/linux/">Linux</a></li><li><a class="tocitem" href="../build/macos/">macOS</a></li><li><a class="tocitem" href="../build/windows/">Windows</a></li><li><a class="tocitem" href="../build/freebsd/">FreeBSD</a></li><li><a class="tocitem" href="../build/arm/">ARM (Linux)</a></li><li><a class="tocitem" href="../build/riscv/">RISC-V (Linux)</a></li><li><a class="tocitem" href="../build/distributing/">Binary distributions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-4" type="checkbox"/><label class="tocitem" for="menuitem-6-4"><span class="docs-label">Contributor&#39;s Guide</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../contributing/code-changes/">Code changes</a></li><li><a class="tocitem" href="../contributing/tests/">Writing tests</a></li><li><a class="tocitem" href="../contributing/documentation/">Improving documentation</a></li><li><a class="tocitem" href="../contributing/jldoctests/">Writing jldoctests</a></li><li><a class="tocitem" href="../contributing/patch-releases/">Contributing to patch releases</a></li><li><a class="tocitem" href="../contributing/formatting/">Code Formatting Guidelines</a></li><li><a class="tocitem" href="../contributing/git-workflow/">Git workflow recommendations</a></li><li><a class="tocitem" href="../contributing/aiagents/">Using AI agents to work on Julia</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li><a class="is-disabled">Documentation of Julia&#39;s Internals</a></li><li class="is-active"><a href>Proper maintenance and care of multi-threading locks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Proper maintenance and care of multi-threading locks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaLang/julia" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaLang/julia/blob/master/doc/src/devdocs/locks.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Proper-maintenance-and-care-of-multi-threading-locks"><a class="docs-heading-anchor" href="#Proper-maintenance-and-care-of-multi-threading-locks">Proper maintenance and care of multi-threading locks</a><a id="Proper-maintenance-and-care-of-multi-threading-locks-1"></a><a class="docs-heading-anchor-permalink" href="#Proper-maintenance-and-care-of-multi-threading-locks" title="Permalink"></a></h1><p>The following strategies are used to ensure that the code is dead-lock free (generally by addressing the 4th Coffman condition: circular wait).</p><ol><li>structure code such that only one lock will need to be acquired at a time</li><li>always acquire shared locks in the same order, as given by the table below</li><li>avoid constructs that expect to need unrestricted recursion</li></ol><h2 id="Types-of-locks"><a class="docs-heading-anchor" href="#Types-of-locks">Types of locks</a><a id="Types-of-locks-1"></a><a class="docs-heading-anchor-permalink" href="#Types-of-locks" title="Permalink"></a></h2><p><code>uv_mutex_t</code> (or <code>std::mutex</code>) is a wrapper around platform-specific locks (<code>pthread_mutex_t</code> on Unix, <code>CRITICAL_SECTION</code> on Windows).  It may cause the current OS thread to block, is not reentrant, and is not a safepoint.</p><p><code>jl_mutex_t</code> is a reentrant spinlock.  <code>jl_mutex_t</code>s acquired in a <code>try</code> block will be unlocked when we leave the block, either by reaching the end or catching an exception.  <code>JL_LOCK</code>/<code>JL_UNLOCK</code> are safepoints, while <code>JL_LOCK_NOGC</code>/<code>JL_UNLOCK_NOGC</code> are not.  <code>jl_mutex_t</code> must not be held across task switches.</p><h2 id="Lock-hierarchy"><a class="docs-heading-anchor" href="#Lock-hierarchy">Lock hierarchy</a><a id="Lock-hierarchy-1"></a><a class="docs-heading-anchor-permalink" href="#Lock-hierarchy" title="Permalink"></a></h2><p>Below are all of the locks that exist in the system and the mechanisms for using them that avoid the potential for deadlocks (no Ostrich algorithm allowed here). Except in the special cases where a rule for avoiding deadlock is given, no lock of a lower level may acquire a lock at a higher level.</p><h3 id="Level-1"><a class="docs-heading-anchor" href="#Level-1">Level 1</a><a id="Level-1-1"></a><a class="docs-heading-anchor-permalink" href="#Level-1" title="Permalink"></a></h3><p>No other lock may be acquired when one of these locks is held.  As a result, the code must not do any allocation or hit any safepoints. Note that there are safepoints when doing allocation, enabling/disabling GC, entering/restoring exception frames, and taking/releasing locks.</p><ul><li><p><code>safepoint_lock</code> (<code>uv_mutex_t</code>)</p><div class="admonition is-danger" id="Danger-19015247889daa26"><header class="admonition-header">Danger<a class="admonition-anchor" href="#Danger-19015247889daa26" title="Permalink"></a></header><div class="admonition-body"><p>This lock is acquired implicitly by <code>JL_LOCK</code> and <code>JL_UNLOCK</code>. Use the <code>_NOGC</code> variants to avoid that for level 1 locks.</p></div></div></li><li><p><code>shared_map_lock.mtx</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>finalizers_lock</code> (<code>jl_mutex_t</code>)</p></li><li><p><code>gc_pages_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>gc_perm_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>gc_queue_observer_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>gc_threads_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>flisp_lock</code> (<code>uv_mutex_t</code>)</p><div class="admonition is-info" id="Note-b18c895fae38695d"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-b18c895fae38695d" title="Permalink"></a></header><div class="admonition-body"><p>flisp itself is already threadsafe; this lock only protects the <code>jl_ast_context_list_t</code> pool.  Likewise, the <code>ResourcePool&lt;?&gt;::mutexes</code> just protect the associated resource pool.</p></div></div></li><li><p><code>jl_in_stackwalk</code> (<code>uv_mutex_t</code>, Win32 only)</p></li><li><p><code>ResourcePool&lt;?&gt;.mutex</code> (<code>std::mutex</code>)</p></li><li><p><code>RLST_mutex</code> (<code>std::mutex</code>)</p></li><li><p><code>llvm_printing_mutex</code> (<code>std::mutex</code>)</p></li><li><p><code>jl_locked_stream.mutex</code> (<code>std::mutex</code>)</p></li><li><p><code>debuginfo_asyncsafe</code> (<code>uv_rwlock_t</code>)</p></li><li><p><code>profile_show_peek_cond_lock</code> (<code>jl_mutex_t</code>)</p></li><li><p><code>trampoline_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>bt_data_prof_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>jl_ptls_t.sleep_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>tls_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>page_profile_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>symtab_lock</code> (<code>uv_mutex_t</code>)</p></li><li><p><code>engine_lock</code> (<code>std::mutex</code>)</p></li></ul><h3 id="Level-2"><a class="docs-heading-anchor" href="#Level-2">Level 2</a><a id="Level-2-1"></a><a class="docs-heading-anchor-permalink" href="#Level-2" title="Permalink"></a></h3><ul><li><code>global_roots_lock</code></li><li><code>jl_module_t.lock</code></li><li><code>newly_inferred_mutex</code></li><li><code>JLDebuginfoPlugin.PluginMutex</code> (<code>std::mutex</code>)</li><li><code>precompile_field_replace_lock</code></li><li><code>live_tasks_lock</code> (<code>uv_mutex_t</code>)</li><li><code>heapsnapshot_lock</code></li><li><code>jitlock</code></li><li><code>jl_safepoint_suspend_all_threads</code> and <code>jl_safepoint_resume_all_threads</code><div class="admonition is-info" id="Note-5c56316b85d0f3fd"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-5c56316b85d0f3fd" title="Permalink"></a></header><div class="admonition-body"><p>Inside a region protected by these functions, all other threads are blocked inside a safepoint.  It is unsafe to take locks that may safepoint in this region.</p></div></div></li></ul><h3 id="Level-3"><a class="docs-heading-anchor" href="#Level-3">Level 3</a><a id="Level-3-1"></a><a class="docs-heading-anchor-permalink" href="#Level-3" title="Permalink"></a></h3><ul><li><code>jl_method_t.writelock</code></li><li><code>typecache_lock</code></li><li><code>libmap_lock</code></li></ul><h3 id="Level-4"><a class="docs-heading-anchor" href="#Level-4">Level 4</a><a id="Level-4-1"></a><a class="docs-heading-anchor-permalink" href="#Level-4" title="Permalink"></a></h3><ul><li><code>jl_methcache_t.writelock</code></li></ul><h3 id="Level-5"><a class="docs-heading-anchor" href="#Level-5">Level 5</a><a id="Level-5-1"></a><a class="docs-heading-anchor-permalink" href="#Level-5" title="Permalink"></a></h3><ul><li><code>jl_methtable_t.writelock</code></li></ul><h3 id="Level-6"><a class="docs-heading-anchor" href="#Level-6">Level 6</a><a id="Level-6-1"></a><a class="docs-heading-anchor-permalink" href="#Level-6" title="Permalink"></a></h3><p>No Julia code may be called while holding a lock above this point.</p><ul><li><code>world_counter_lock</code></li></ul><h3 id="Level-7"><a class="docs-heading-anchor" href="#Level-7">Level 7</a><a id="Level-7-1"></a><a class="docs-heading-anchor-permalink" href="#Level-7" title="Permalink"></a></h3><ul><li><p><code>JuliaOJIT::EmissionMutex</code> (<code>std::recursive_mutex</code>)</p></li><li><p><code>jl_modules_mutex</code></p></li><li><p><code>jl_uv_mutex</code> (known as <code>iolock</code> from Julia)</p><div class="admonition is-danger" id="Danger-1bca4bb5c53676c6"><header class="admonition-header">Danger<a class="admonition-anchor" href="#Danger-1bca4bb5c53676c6" title="Permalink"></a></header><div class="admonition-body"><p>Doing any I/O (for example, printing warning messages or debug information) while holding any other lock listed above may result in pernicious and hard-to-find deadlocks.</p></div></div></li><li><p>Individual <code>ThreadSynchronizer</code> locks</p><div class="admonition is-danger" id="Danger-655bc0c3cddbbbe3"><header class="admonition-header">Danger<a class="admonition-anchor" href="#Danger-655bc0c3cddbbbe3" title="Permalink"></a></header><div class="admonition-body"><p>This may continue to be held after releasing the iolock, or acquired without it, but be very careful to never attempt to acquire the iolock while holding it.</p></div></div></li><li><p><code>Libdl.LazyLibrary.lock</code> (<code>ReentrantLock</code>)</p></li><li><p><code>orc::ThreadSafeContext</code></p></li><li><p><code>cfun_lock</code></p></li></ul><h3 id="Level-8"><a class="docs-heading-anchor" href="#Level-8">Level 8</a><a id="Level-8-1"></a><a class="docs-heading-anchor-permalink" href="#Level-8" title="Permalink"></a></h3><ul><li><code>precomp_statement_out_lock</code></li><li><code>dispatch_statement_out_lock</code></li></ul><h2 id="Exceptions-to-the-lock-hierarchy"><a class="docs-heading-anchor" href="#Exceptions-to-the-lock-hierarchy">Exceptions to the lock hierarchy</a><a id="Exceptions-to-the-lock-hierarchy-1"></a><a class="docs-heading-anchor-permalink" href="#Exceptions-to-the-lock-hierarchy" title="Permalink"></a></h2><p>Ordinarily, it is forbidden to acquire locks of equal level to a lock already held.  In these specific cases we use a special protocol for acquiring locks at the same level:</p><ul><li><p><code>jl_method_t.writelock</code></p><p>Invalidation acquires the lock for every method during its depth-first search for backedges.  To avoid deadlocks, we must already hold <code>world_counter_lock</code> before acquiring multiple <code>jl_method_t.writelock</code>s.</p></li></ul><h3 id="Broken-locks"><a class="docs-heading-anchor" href="#Broken-locks">Broken locks</a><a id="Broken-locks-1"></a><a class="docs-heading-anchor-permalink" href="#Broken-locks" title="Permalink"></a></h3><p>The following locks are broken:</p><ul><li><p><code>loading.jl</code>: <code>require</code> and <code>register_root_module</code></p><p>This file potentially has numerous problems. (fix: needs locks)</p></li></ul><h2 id="Updates-to-the-world-counter"><a class="docs-heading-anchor" href="#Updates-to-the-world-counter">Updates to the world counter</a><a id="Updates-to-the-world-counter-1"></a><a class="docs-heading-anchor-permalink" href="#Updates-to-the-world-counter" title="Permalink"></a></h2><p>Thanks to the <a href="../../manual/worldage/#man-world-age">world age</a> mechanism, Julia can allow the replacement of both methods and bindings, yet remain amenable to optimization. Every compiled <code>CodeInstance</code> has a range of valid world ages; we could conservatively assume all CIs are stale after a world age increment.  However, to avoid spurious recompilation, we track dependencies, called &quot;edges&quot;, while maintaining the following invariant:</p><p>For every published <code>CodeInstance</code>, either:</p><ul><li><code>min_world</code> and <code>max_world</code> are finite, and the CI is valid for every world in that range.</li><li><code>max_world</code> is ∞ (<code>-1</code>), and this CI is ready for invalidation, meaning for every forward edge:<ul><li>If the edge is a <code>CodeInstance</code> that is invoked or inlined into this CI, the edge&#39;s <code>MethodInstance</code> <code>backedge</code> array has an entry pointing back.</li><li>If the edge is a <code>Binding</code>:<ul><li>If the binding is in another module, it has an entry for this CI in its <code>backedges</code> array.</li><li>If the binding is in the same module, the <code>Method</code> for this CI is in the module&#39;s <code>scanned_methods</code> array.</li></ul></li></ul></li></ul><p>For example, the following code replaces a constant in another module, causing a chain of invalidations:</p><pre><code class="language-julia hljs">const c1 = 1
module M const c2 = 2 end
f() = getfield(M, :c2)
g() = f() + c1

g()                   # compile g

@eval M const c2 = 3  # invalidate f, g
g()                   # recompile g</code></pre><p>After compiling the two versions of <code>g()</code>, the global cache looks like this: <img src="../img/invalidation-example.png" alt="Global cache state after invalidation"/></p><p>The maximum world age, <code>jl_world_counter</code>, is protected by the <code>world_counter_lock</code>.  Julia uses a form of optimistic concurrency control to allow type inference without holding <code>world_counter_lock</code>.</p><p>Publishing a new method or binding follows these steps:</p><ul><li>Acquire <code>world_counter_lock</code>.</li><li>Relaxed-load <code>jl_world_counter</code> and let <code>new_world = jl_world_counter + 1</code>.</li><li>Publish the new binding partitions or method table entries with world range <code>[new_world, ∞)</code>.  This step is described in the section on the <a href="#man-lock-free-data">lock free data structures</a>.</li><li>Release-store <code>new_world</code> to <code>jl_world_counter</code>.</li><li>Release <code>world_counter_lock</code>.</li></ul><p>Type inference proceeds like so:</p><ul><li>Acquire-load <code>jl_world_counter</code> (call this <code>validation_world</code>).</li><li>Perform type inference in that world, reading the bindings and method table in that world using the lock-free data structures.</li><li>Store back edges for every inferred <code>CodeInstance</code>:<ul><li>For non-local bindings, this acquires the binding&#39;s module&#39;s lock.</li><li>For CIs, this acquires the method&#39;s lock.</li></ul></li><li>Acquire <code>world_counter_lock</code>.</li><li>Relaxed-load <code>jl_world_counter</code> and compare it to <code>validation_world</code>:<ul><li>If it is different, leave the valid world ranges for the inferred CIs unchanged.</li><li>If it is unchanged, our optimism was rewarded.  We can promote all the inferred CIs valid in <code>validation_world</code> to <code>[validation_world, ∞)</code> and rely on the backedges for invalidation.</li></ul></li><li>Release <code>world_counter_lock</code>.</li></ul><p><img src="../img/typeinf-promotion.png" alt="Two threads doing type inference while another adds a method"/></p><p>In the above diagram, threads 1 and 2 are doing type inference (the dotted line), while thread 3 is activating a new method.  The solid boxes represent critical sections where the <code>world_counter_lock</code> is held.  <code>acq</code>, <code>rel</code>, and <code>read</code>, are acquire loads, release stores, and relaxed loads respectively.</p><p>T1 promotes its CI in time, but T2 takes too long, blocking on <code>world_counter_lock</code> until T3 has finished publishing the new method and incrementing the world counter.  It reads <code>W+1</code> and fails to promote its CI, leaving it with a maximum world of <code>W</code>.</p><h2 id="man-lock-free-data"><a class="docs-heading-anchor" href="#man-lock-free-data">Lock free data structures</a><a id="man-lock-free-data-1"></a><a class="docs-heading-anchor-permalink" href="#man-lock-free-data" title="Permalink"></a></h2><p>TODO</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../boundscheck/">« Bounds checking</a><a class="docs-footer-nextpage" href="../offset-arrays/">Arrays with custom indices »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.4 on <span class="colophon-date" title="Monday 22 September 2025 07:31">Monday 22 September 2025</span>. Using Julia version 1.13.0-DEV.1182.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
